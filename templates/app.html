<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Experiencia</title>
<!-- Pusher JS -->

    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>


    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    
    <!-- jQuery Validation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    
    <style>
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Encuesta de Experiencia</h2>
        <form id="experienceForm"  action="/app/guardar" method="POST">
            <div class="form-group mb-3">
                <label for="name">Nombre y Apellido</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Nombre y Apellido" required>
            </div>
            <div class="form-group mb-3">
                <label for="comment">Comentario</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
            </div>
            <div class="form-group mb-3">
                <label for="rating">Calificación (0 a 5)</label>
                <input type="number" class="form-control" id="rating" name="rating" min="0" max="5" required>
            </div>
            <button id="btnCalificarFA" name="btnCalificarFA" type="submit" class="btn btn-primary">Calificar</button>
        </form>
    </div>

<div id="divEncuestas"></div>
    
        <!-- table index 0 -->
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Nombre y apellido</th>
                    <th>Comentario</th>
                    <th>Calificacion</th>

                </tr>
            </thead>
            <tbody id="tbodyEncuestas"></tbody>
        </table>
    </div>

    
    <script>
 window.addEventListener("load", function (event) {
            // Realizamos un SELECT a la BD con FLASK y lo imprimimos en el TBODY
            function buscar() {
                $.get("/buscar", function (respuesta) {
                    // Imprimimos la respuesta de FLASK con SELECT para saber cómo acceder a cada valor y colocarlos en el TBODY
                    // console.log(respuesta)

                    $("#tbodyEncuestas").html("")

                    for (var x in respuesta) {
                        var encuesta = respuesta[x]
                        $("#tbodyEncuestas").append(`<tr>
                            <td>${encuesta[1]}</td>
                            <td>${encuesta[2]}</td>
                            <td>${encuesta[3]}</td>
                        </tr>`)
                    }
                })
            }

            buscar()

            Pusher.logToConsole = true
            
            var pusher = new Pusher("e7b4efacf7381f83e05e", {
                cluster: "us2"
            })

            // Canal ---> Donde se concentran los hilos con los clientes conectados
            var channel = pusher.subscribe("canalRegistroEncuesta");

            // Evento --> El código que se accionará con la información enviada o el uso del canal
            channel.bind("registroEventoEncuests", function (encuesta) {
                // 1. Notificar el evento
                // alert("Ocurrió el evento")

                // 2. Recibir información enviada en el evento
                // console.log(temperaturaHumedad)

                // 3. Trabajar información enviada por el evento
                /**
                $("#tbodyTemperaturaHumedad").prepend(`<tr>
                    <td>${temperaturaHumedad.temperatura}</td>
                    <td>${temperaturaHumedad.humedad}</td>
                    <td></td>
                </tr>`)
                */

                // 4. Mandar a llamar otro código luego del evento
                buscar()
            })
        })


        ////aqui termina el codigo de arriba
        $(document).ready(function () {
            // Validaciones con JQuery Validation
            $("#experienceForm").validate({
                rules: {
                    name: {
                        required: true,
                        minlength: 10,
                        maxlength: 50,
                        lettersonly: true // Solo letras
                    },
                    comment: {
                        required: true,
                        minlength: 10,
                        maxlength: 50
                    },
                    rating: {
                        required: true,
                        number: true,
                        min: 0,
                        max: 5
                    }
                },
                messages: {
                    name: {
                        required: "Por favor, ingresa tu nombre y apellido.",
                        minlength: "Debe contener al menos 10 caracteres.",
                        maxlength: "Debe contener como máximo 50 caracteres.",
                        lettersonly: "Solo se permiten letras."
                    },
                    comment: {
                        required: "Por favor, ingresa un comentario.",
                        minlength: "El comentario debe tener al menos 10 caracteres.",
                        maxlength: "El comentario debe tener máximo 50 caracteres."
                    },
                    rating: {
                        required: "Por favor, ingresa una calificación.",
                        number: "La calificación debe ser un número.",
                        min: "La calificación mínima es 0.",
                        max: "La calificación máxima es 5."
                    }
                }
            });


            
            // Agregar método para validar solo letras
            jQuery.validator.addMethod("lettersonly", function(value, element) {
                return this.optional(element) || /^[a-zA-Z\s]+$/.test(value);
            }, "Solo se permiten letras.");

            
        });

         $("#experienceForm").submit(function (event) {
                event.preventDefault()

                $.post("/app/guardar", $(this).serialize(), function (respuesta) {
                    console.log(respuesta)
                    });
                     });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
